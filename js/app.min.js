(() => {
    // Objet pour stocker les métriques de performance
    const perfData = {
        fcp: null,
        lcp: null,
        cls: 0,
        clsEntries: [],
        longTasks: 0,
        longTasksTime: 0,
        totalBlockingTime: 0,
        resources: [],
        totalRequests: 0,
        totalBytes: 0,
        nav: null
    };

    const formatTime = v => v == null ? "-" : Math.round(v) + " ms";
    const formatBytes = v => v == null ? "-" : (v / 1024).toFixed(1) + " KB";

    // Observateurs de performance
    try {
        // First Contentful Paint
        const fcpObserver = new PerformanceObserver(entries => {
            for (const entry of entries) {
                if (entry.name === "first-contentful-paint" && perfData.fcp == null) {
                    perfData.fcp = entry.startTime;
                    updatePanel();
                    fcpObserver.disconnect();
                }
            }
        });
        fcpObserver.observe({ type: "paint", buffered: true });
    } catch (e) {}

    try {
        // Largest Contentful Paint
        const lcpObserver = new PerformanceObserver(entries => {
            for (const entry of entries) {
                perfData.lcp = entry.renderTime || entry.loadTime || entry.startTime;
                updatePanel();
            }
        });
        lcpObserver.observe({ type: "largest-contentful-paint", buffered: true });
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "hidden") lcpObserver.takeRecords();
        });
    } catch (e) {}

    try {
        // Cumulative Layout Shift
        const clsObserver = new PerformanceObserver(entries => {
            for (const entry of entries) {
                if (!entry.hadRecentInput) {
                    perfData.cls += entry.value;
                    perfData.clsEntries.push(entry);
                }
            }
            updatePanel();
        });
        clsObserver.observe({ type: "layout-shift", buffered: true });
    } catch (e) {}

    try {
        // Long Tasks
        const longTaskObserver = new PerformanceObserver(entries => {
            for (const entry of entries) {
                perfData.longTasks++;
                perfData.longTasksTime += entry.duration;
                perfData.totalBlockingTime += Math.max(0, entry.duration - 50);
            }
            updatePanel();
        });
        longTaskObserver.observe({ entryTypes: ["longtask"] });
    } catch (e) {}

    // Collecte des ressources
    function collectResources() {
        const resources = performance.getEntriesByType("resource");
        perfData.resources = resources;
        perfData.totalRequests = resources.length + 1;

        let totalSize = 0;
        for (const res of resources) {
            const size = (res.transferSize && res.transferSize > 0) ? res.transferSize : (res.encodedBodySize || 0);
            totalSize += size;
        }
        perfData.totalBytes = totalSize;
    }

    // Collecte des données de navigation
    function collectNavigation() {
        const nav = performance.getEntriesByType("navigation")[0];
        if (nav) perfData.nav = nav;
    }

    // Création du panneau de performance
    const panel = document.createElement("div");
    panel.id = "perf-panel";
    Object.assign(panel.style, {
        position: "fixed",
        right: "16px",
        bottom: "16px",
        zIndex: 9999,
        width: "320px",
        maxWidth: "90vw",
        fontFamily: "ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial",
        background: "rgba(10,12,28,.9)",
        color: "#E8ECF1",
        border: "1px solid rgba(255,255,255,.12)",
        borderRadius: "12px",
        boxShadow: "0 10px 40px rgba(0,0,0,.5)",
        backdropFilter: "blur(6px) saturate(120%)",
        padding: "12px 14px"
    });

    panel.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px">
            <strong style="letter-spacing:.2px">Évaluation perfs</strong>
            <div>
                <button id="perf-refresh" style="background:#7C5CFF;color:white;border:0;border-radius:8px;padding:6px 10px;cursor:pointer">Mesurer</button>
                <button id="perf-close" style="background:transparent;color:#c9d1d9;border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:6px 8px;margin-left:6px;cursor:pointer">×</button>
            </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px">
            <div><div style="opacity:.8">FCP</div><div id="m-fcp" style="font-weight:600">-</div></div>
            <div><div style="opacity:.8">LCP</div><div id="m-lcp" style="font-weight:600">-</div></div>
            <div><div style="opacity:.8">CLS</div><div id="m-cls" style="font-weight:600">-</div></div>
            <div><div style="opacity:.8">TBT (≈)</div><div id="m-tbt" style="font-weight:600">-</div></div>
            <div><div style="opacity:.8">Requêtes</div><div id="m-req" style="font-weight:600">-</div></div>
            <div><div style="opacity:.8">Poids total</div><div id="m-bytes" style="font-weight:600">-</div></div>
        </div>
        <div style="margin-top:8px;font-size:12px;opacity:.8">
            <div id="m-note">Cliquez sur <em>Mesurer</em> après vos modifications.</div>
        </div>
    `;

    document.addEventListener("DOMContentLoaded", () => {
        document.body.appendChild(panel);
    });

    function updatePanel() {
        collectResources();
        collectNavigation();

        const $ = selector => panel.querySelector(selector);
        $("#m-fcp").textContent = formatTime(perfData.fcp);
        $("#m-lcp").textContent = formatTime(perfData.lcp);
        $("#m-cls").textContent = perfData.cls ? perfData.cls.toFixed(3) : "-";
        $("#m-tbt").textContent = perfData.totalBlockingTime ? formatTime(perfData.totalBlockingTime) : "-";
        $("#m-req").textContent = perfData.totalRequests || "-";
        $("#m-bytes").textContent = formatBytes(perfData.totalBytes);

        window.__metrics = {
            fcp: perfData.fcp,
            lcp: perfData.lcp,
            cls: perfData.cls,
            tbtApprox: perfData.totalBlockingTime,
            totalRequests: perfData.totalRequests,
            totalBytes: perfData.totalBytes,
            navigation: perfData.nav
        };
    }

    document.addEventListener("click", (e) => {
        if (!e.target) return;
        if (e.target.id === "perf-refresh") updatePanel();
        if (e.target.id === "perf-close") panel.remove();
    });

    window.addEventListener("load", () => setTimeout(updatePanel, 0));
})();

// Bloc pour images et tâche idle
(() => {
    function wasteCPU() {
        try {
            const arr = new Array(1024).fill(0).map(() => Math.random());
            window.__waste = arr;
        } catch (e) {}
    }

    if ("requestIdleCallback" in window) {
        requestIdleCallback(wasteCPU, { timeout: 2000 });
    } else {
        setTimeout(wasteCPU, 1500);
    }

    window.addEventListener("load", () => {
        document.querySelectorAll(".card img").forEach(img => {
            if (img.complete) img.classList.add("loaded");
            else img.addEventListener("load", () => img.classList.add("loaded"));
        });
    });
})();
